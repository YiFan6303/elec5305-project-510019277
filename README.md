# Instrument Classification Project — Full Usage Guide

This README explains exactly how to run the project, how to train the model, and how to test any audio file.

---

# 1. Project Structure

Your project directory should look like this:

```
project_root/
│
├─ dataset/                      # Training dataset (Philharmonia)
│   ├─ cello/
│   ├─ flute/
│   ├─ oboe/
│   ├─ trombone/
│   ├─ tuba/
│   └─ ... (one folder per instrument)
│
├─ demo_data/                    # Test audio for demo (you may replace with your own)
│   ├─ cello_example.mp3
│   └─ piano_unknown.mp3
│
├─ results/
│   ├─ ml/
│   │   ├─ philharmonia_features.mat      # Extracted features (auto-generated)
│   │   ├─ instrument_classifier.mat      # Trained ML model (auto-generated)
│   │   └─ demo_segment_scores.csv        # Segment-level confidence output
│   └─ plots/ and audio/ generated by synthesis scripts
│
├─ src/
│   ├─ feature extraction helpers
│   ├─ additive & FM synthesis scripts
│   └─ utils (path handlers, etc.)
│
├─ extract_philharmonia_features.mlx
├─ train_instrument_classifier.mlx
├─ predict_instrument_demo.mlx
├─ main_ml_pipeline.mlx
└─ main_synthesis_demo.mlx
```

---

# 2. Software Requirements

- MATLAB R2025a  
- Audio Toolbox  
- Statistics and Machine Learning Toolbox  
- (Optional) Signal Processing Toolbox  

---

# 3. How to Run the Full ML Pipeline

Use the integrated pipeline:

1. Open MATLAB and set this folder as your working directory.
2. Run:

```matlab
main_ml_pipeline
```


After it finishes, you will have to:
```
---


### **Then you need to run the main_synthesis_demo**

### **Then you need to run the extract_philharmonia_features to load all the test audio**

```matlab
extract_philharmonia_features
```

Outputs:

```
results/ml/philharmonia_features.mat
```

---

### **Step 2 — Train classifier**

```matlab
train_instrument_classifier
```

This script:

- Loads features  
- Splits train/test  
- Normalizes (z-score)  
- Trains RF / SVM / kNN / NB  
- Chooses best model (usually SVM-RBF)  
- Saves model:

```
results/ml/instrument_classifier.mat
```

---

# 4. Running the Demo (Test Any Audio)

This is the script that performs segment-wise classification:

```matlab
predict_instrument_demo
```

It will:

- Load saved classifier  
- Load test audio  
- Preprocess (trim silence + normalize)  
- Segment audio (0.8s windows)  
- Predict each segment  
- Use majority vote for final decision  
- Apply open-set detection (Unknown Instrument)  
- Generate:
  - waveform + spectrogram  
  - class-score heatmap  
  - time-axis segment labels  
  - CSV of segment scores  

---

# 5. How to Change the Test Audio

In `predict_instrument_demo.mlx`, find this line:

```matlab
testfile = "demo_data/cello_example.mp3";
```

To test another known instrument:

```matlab
testfile = "demo_data/flute_demo.wav";
```

To test an unknown instrument (e.g., piano):

```matlab
testfile = "demo_data/piano_unknown.mp3";
```

---

# 6. IMPORTANT — Testing Unknown Instruments

To correctly test unknown instruments:

### 1. Make sure the file is **NOT inside the `dataset/` directory**  
Otherwise MATLAB will treat it as a known class.

### 2. Put unknown audio inside:

```
demo_data/
```

### 3. Set path:

```matlab
testfile = "demo_data/piano_unknown.mp3";
```

### 4. The system automatically applies:

- Low probability check  
- Voting consistency check  
- Mahalanobis distance check  

If the file does not resemble any trained class, output will be:

```
FINAL DECISION: Unknown Instrument
```

---

# 7. Replacing the Dataset (Optional)

If you want to change the training dataset:

### 1. Replace folders under:

```
dataset/
```

### 2. Ensure structure:

```
dataset/instrument_name/*.mp3
dataset/instrument_name2/*.wav
```

### 3. Re-run:

```matlab
extract_philharmonia_features
train_instrument_classifier
```

---

# 8. Additive & FM Synthesis (Optional Part)

To run synthesis demos:

```matlab
main_synthesis_demo
```

Outputs:

```
results/audio/additive_A4.wav
results/audio/fm_A4_r2_I4.wav
```

These demonstrate harmonic structure differences between synthesis methods.

---

# 9. Summary of All Key Scripts

| Script | Purpose |
|-------|---------|
| `extract_philharmonia_features.mlx` | Extract timbre features from dataset |
| `train_instrument_classifier.mlx` | Train RF/SVM/kNN/NB and save best model |
| `main_ml_pipeline.mlx` | One-click pipeline (extract → train → evaluate) |
| `predict_instrument_demo.mlx` | Test audio classification + open-set detection |
| `main_synthesis_demo.mlx` | Additive vs FM synthesis comparison |
| `src/` | Helper functions, DSP tools, utilities |

---

# 10. Troubleshooting

### **Q1. Demo outputs “Unknown Instrument” for everything?**

- Test file too short (<0.3s after trimming)  
- Wrong sampling rate conversion  
- Heavy silence at start → adjust silence threshold  

---

### **Q2. Feature extraction says “No MFCC”?**

Check that Audio Toolbox is installed.

---

### **Q3. Results folder missing?**

All scripts auto-create required directories.

---

# 11. Author

Yi Fan (SID: 510019277)  
University of Sydney  
ELEC5305 – Acoustics, Speech & Signal Processing
